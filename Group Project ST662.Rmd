---
title: "Group Project ST662"
author: "Susan Edgeworth, James Ferris, Pengyu Yang, Jack Hickey, Aaron Doyle "
date: "30/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Is there a particular airline that is more on time than others?

A note on how I obtained the data used:
To get the total delay of each airline I made a new column that adds the arrival delay to the departure delay which gives the total delay of the flight. This will make a clearer picture of which airline has the most delays from departure to arrival. 

The first plot shows the average delay of each airlines from their destination. The highest average delays are from Frontier airlines. It seems from this graph that the lowest average delays are in the Alaska Airlines airline, in fact it seems they ahve a defecit of delays meaning they had either early or on time in their total. This makes Alaska airlines appear to be the most timely airline compared with others, however more analysis needs to be done here to assess the time delays as there are more flights recorded for certain airlines and aparant outliers which may scew the average. 

```{r fig.width=10, fig.height=7,  fig.fullwidth = TRUE}
library(nycflights13)
library(dplyr)
library(ggplot2)
library(plotly)
library(RColorBrewer)
library(tidyverse)
library(sf)
library(hrbrthemes)
library(viridis)

head(flights)
head(airlines)
head(airports)



#This is to get the total delay which will be used to see what airline has the most and least delays:
flights<- mutate(flights, totaldelay = arr_delay + dep_delay)

# Adding names of the carrier and changing the column name for clarity:
flights<- flights %>% left_join(airlines, by = c('carrier' = 'carrier'))
colnames(flights)[21]<- "CarrierName"

delays<-flights %>% group_by(CarrierName) %>% 
  summarise(Average_Delay = mean(totaldelay, na.rm =
TRUE)) %>% 
  ggplot(aes(reorder(CarrierName,Average_Delay), Average_Delay, fill= CarrierName)) + geom_bar(stat ='identity', color = rainbow(16)) + scale_x_discrete(guide = guide_axis(angle = 90)) 

delays<-delays + theme(
  panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black"))+ 
  ggtitle("Average Delay by Airline") +
  xlab("Airline") + ylab("Average Delay")


delays
```
Here is a list of the departure delays starting with the carrier that has the smallest average delay - Alaska Airlines Inc. with an average delay of -4.1 hours. This shows us that Alaska Airlines appears to be more on time than the other airlines in our data set. 

```{r fig.width=10, fig.height=7,  fig.fullwidth = TRUE}

top16 <- flights %>%
  group_by(CarrierName) %>%
  summarize(avg_delay = mean(totaldelay, na.rm = TRUE)) %>%
  arrange(avg_delay) %>%
  top_n(n = 16)

top16
```


Because there are apparent outliers for some delays within each carrier, it may be helpful to look at a certain threshold; where the total delay is more than an hour, this would constitute airlines that are late departing and late arriving. This graph shows a different outcome than before, while Frontier airlines seems to have the highest average delays, it has one of the lowest flights with delays that are more than an hour. Alaska Airlines has 56 flights that had over an hour delay, compared to ExpressJet Airlines with a whopping 11503 flights with over an hour delay. 
```{r fig.width=10, fig.height=7,  fig.fullwidth = TRUE}


hourdelay<-flights %>% filter(totaldelay > 60) %>% count(CarrierName, sort =TRUE) %>% 
  mutate(CarrierName = factor(CarrierName, levels = CarrierName, ordered =TRUE)) %>%
ggplot(aes(CarrierName, n, fill = CarrierName)) + geom_bar(stat ='identity', color = rainbow(16)) + scale_x_discrete(guide = guide_axis(angle = 90)) 

hourdelay<-hourdelay + theme(
  panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black"))+ 
  ggtitle("Delay by More Than an Hour") +
  xlab("Airline") + ylab("Count")
hourdelay
```

This map looks at the airports that have the most delays on arrival, the larger dot represents a bigger delay (in minutes).
```{r fig.width=15, fig.height=15,  fig.fullwidth = TRUE}
library(albersusa)
m<-usa_sf()
library("maps")
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
states <- cbind(states, st_coordinates(st_centroid(states)))
library("tools")
states$ID <- toTitleCase(states$ID)


flights1 <- flights %>% group_by(dest) %>% 
  summarise(avg_delay = mean(totaldelay, na.rm = T)) %>% 
  left_join(airports, c("dest"="faa")) %>%
  arrange(desc(avg_delay))



head(flights1)

map1<-ggplot(data = m) +
    geom_sf(fill = "chartreuse1",alpha = 0.45) +
    geom_sf(data = states, alpha = 0.25, color = "darkgreen", size = 0.3) + 
    geom_text(data = states, aes(X, Y, label = ID),check_overlap = TRUE,fontface = "bold", size = 2) +
  geom_point(data = flights1, aes(x = lon, y = lat, size = avg_delay, fill = name), color = "purple", alpha = 0.7)+ guides(fill = FALSE) + scale_size(range = c(0, 5), name="Average Delay in Minutes") +
  coord_sf(
    xlim = c(-130, -70),
    ylim = c(20, 50)
  )


map1<-map1 + theme(
  panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_rect(colour= "aliceblue", fill = "aliceblue",
                                size = 0.5, linetype = "solid"),
  axis.line = element_line(colour = "black"))+ 
  ggtitle("Average Delays by Airport") +
  xlab("Lat") + ylab("Long")
map1

ggplotly(hide_legend(map1))

top10<- flights1 %>%
  group_by(name) %>%
  arrange(avg_delay) %>%
  top_n(n = 10)

top10
```


```{r}

```

